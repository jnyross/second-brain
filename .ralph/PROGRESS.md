# .ralph/PROGRESS.md

## Runbook

- Project root (workingDirectory): this folder
- Contract: `Prompt.md`
- Requirements: `PRD.md`
- Tasks: `.ralph/TASKS.json`
- Needs input: `.ralph/NEEDS_INPUT.md` (only when blocked)
- Bootstrap: `scripts/bootstrap.sh`
- Bootstrap test: `scripts/bootstrap_test.sh`

## Current State

- Initialized: yes
- Status: Phase 0 complete. Phases 1-5 complete. T-200 (Dockerfile), T-201 (docker-compose.yml), T-202 (GitHub Actions CI) complete. Next: T-203 (GitHub Actions CD), T-204 (server setup script), or T-205 (health check script).

## Iteration Log

- Init: created contract artifacts.
- Iteration 1 (T-013)
  - Commands: scripts/bootstrap_test.sh (fail: missing bootstrap.sh), scripts/bootstrap_test.sh (pass)
  - Results: bootstrap test passed
  - Commit: not created (commit restricted by session instructions)
- Iteration 1 (T-013) follow-up
  - Commands: scripts/bootstrap_test.sh (pass)
  - Results: bootstrap test passed with cleanup
  - Commit: not created (commit restricted by session instructions)
- Iteration 1 (T-013) review fixes
  - Commands: scripts/bootstrap_test.sh (pass)
  - Results: bootstrap test passed after idempotency fixes
  - Commit: not created (commit restricted by session instructions)
- Iteration 2 (T-014)
  - Commands: scripts/bootstrap_test.sh (pass), scripts/verify_test.sh (pass)
  - Results: verify script implemented and passes against bootstrap fixture
  - Commit: not created (commit restricted by session instructions)
- Iteration 3 (T-000 hygiene)
  - Commands: jq -e '.' .ralph/TASKS.json (pass)
  - Results: synced P0 backlog tasks into .ralph/TASKS.json
  - Commit: not created (commit restricted by session instructions)
- Iteration 4 (T-016)
  - Commands: scripts/smoke_test_test.sh (pass)
  - Results: smoke test script implemented and passes against bootstrap fixture
  - Commit: not created (commit restricted by session instructions)
- Iteration 5 (T-001)
  - Commands: scripts/knowledge_schema_test.sh (pass)
  - Results: knowledge index schema and validation script added
  - Commit: not created (commit restricted by session instructions)
- Iteration 6 (T-002)
  - Commands: scripts/at_001_task_creation_test.sh (pass), scripts/at_002_task_completion_test.sh (pass)
  - Results: task create/complete scripts added and validated by acceptance tests
  - Commit: not created (commit restricted by session instructions)
- Iteration 7 (T-003)
  - Commands: scripts/conversation_log_test.sh (pass)
  - Results: conversation logging system added - logs to conversation/log.jsonl in JSONL format
  - Commit: not created (commit restricted by session instructions)
- Iteration 8 (T-004) - REVERTED
  - Results: HITL approval queue implemented then removed - switched to Autonomous mode per user request
  - Changes: PRD.md Mode changed to Autonomous, removed --hitl flag, removed T-004/AT-004, deleted approval_queue.sh
  - Commit: not created (commit restricted by session instructions)
- Iteration 9 (T-005)
  - Commands: scripts/at_005_stuck_no_progress_test.sh (pass)
  - Results: No-progress stuck detection implemented via scripts/stuck_detector.sh
  - Commit: pending
- Iteration 10 (T-006)
  - Commands: scripts/at_006_stuck_same_error_test.sh (pass)
  - Results: Same-error stuck detection (already in stuck_detector.sh), AT-006 test validates
  - Commit: pending
- Iteration 11 (T-007)
  - Commands: scripts/at_007_cost_tracking_test.sh (pass)
  - Results: Cost tracking implemented via scripts/cost_tracker.sh, enforces daily budget
  - Commit: pending
- Iteration 12 (T-008)
  - Commands: scripts/at_008_sandbox_test.sh (pass)
  - Results: Sandbox enforcement via scripts/sandbox_guard.sh, logs to security_log.json
  - Commit: pending
- Iteration 13 (T-009)
  - Commands: scripts/at_009_learning_test.sh (pass)
  - Results: Learning database via scripts/learning_db.sh, pattern matching for corrections
  - Commit: pending
- Iteration 14 (T-010)
  - Commands: scripts/task_engine_test.sh (pass)
  - Results: Task execution engine with full CRUD + history + notifications
  - Commit: pending
- Iteration 15 (T-011)
  - Commands: scripts/knowledge_search_test.sh (pass)
  - Results: Knowledge base retrieval with indexing and citation-based search
  - Commit: pending
- Iteration 16 (T-012)
  - Commands: scripts/claude_adapter_test.sh (pass)
  - Results: Claude CLI adapter with streaming and tool-calling support
  - Commit: pending
- Iteration 17 (T-015)
  - Commands: scripts/run_test.sh (pass)
  - Results: Run script with config, check, start, dry-run modes
  - Commit: pending
- Final Verification
  - All 16 P0 tasks complete with passes: true
  - All 16 test harnesses (*_test.sh) pass
  - Acceptance tests: AT-001, AT-002, AT-003, AT-005, AT-006, AT-007, AT-008, AT-009 implemented and passing
- PRD v0.4.0 Critical Gap Fixes
  - Oracle agent reviewed PRD for architecture gaps
  - Added Section 1: Tech Stack & Deployment (Python 3.12, aiogram, VPS, systemd)
  - Added Section 1.3: Secrets Management
  - Added Section 1.4: Cost Estimate (~$7-12/mo)
  - Added Section 4.6: Failure Handling (offline queue, retries, rate limiting)
  - Added Section 4.7: Idempotency (dedupe keys, exactly-once processing)
  - Added Section 5.4-5.6: Timezone, Disambiguation, Deletion Semantics
  - Added Section 6.2-6.3: Undo/Rollback Semantics, Confirmation Requirements
  - Enhanced all database schemas with operational fields
  - Added acceptance tests AT-113 through AT-120
- TASKS.json Sync
  - Updated to schema 1.2 with 58 total tasks (16 complete from Phase 0)
  - Added all Phase 1-7 tasks from PRD with dependencies and acceptance tests
- Phase 1 Implementation (T-050, T-051)
  - Created Python project structure with pyproject.toml
  - Implemented Notion API client with retry logic, offline queue, idempotency
  - Created all 9 database schemas (Inbox, Tasks, People, Projects, Places, Preferences, Patterns, Emails, Log)
  - Added scripts/notion_bootstrap.py to create Notion databases
- Phase 2 Implementation (T-060, T-061, T-064)
  - Created Telegram bot with aiogram
  - Implemented text message handler with parser
  - Created response generator
  - Added /start, /help, /today, /status, /debrief command stubs
- Services Implementation
  - Parser: extracts dates, times, people, places from natural language
  - Processor: routes messages, handles high/low confidence
  - BriefingGenerator: creates morning briefings from Notion data
- CLI Implementation
  - assistant run: Start Telegram bot
  - assistant briefing: Send morning briefing
  - assistant check: Verify configuration
  - assistant sync: Process offline queue
- Iteration 18 (T-052) - Entity Extraction Service
  - Created src/assistant/services/entities.py with EntityExtractor class
  - Implemented extraction for people (with/call/email patterns), places (at/near patterns), dates (tomorrow/today/weekday/relative)
  - Added tests/test_entities.py (21 tests)
  - Commands: PYTHONPATH=src python -m pytest tests/test_entities.py -v (21 passed)
  - Commit: pending
- Iteration 19 (T-053) - Confidence Scoring Service
  - Created src/assistant/services/confidence.py with ConfidenceScorer class
  - Scoring factors: action verbs (+25), entities (+5 each, max +15), time (+15), length (+5)
  - Penalties: filler words (-30), questions (-10), vague pronouns (-15)
  - 80% threshold for automatic action vs human review
  - Added tests/test_confidence.py (25 tests)
  - Commands: PYTHONPATH=src python -m pytest tests/test_confidence.py -v (25 passed)
  - Commit: pending
- Iteration 20 (T-054) - Classification Router
  - Created src/assistant/services/router.py with ClassificationRouter class
  - Routes to: Tasks, Inbox, People, Places, Projects based on intent type
  - Secondary targets: links People/Places entities when routing to Tasks
  - Low confidence (<80%) always routes to Inbox with flag_review
  - Added tests/test_router.py (24 tests)
  - Commands: PYTHONPATH=src python -m pytest tests/test_router.py -v (24 passed)
  - Commit: pending
- Iteration 21 (T-062) - Whisper Transcription Service
  - Created src/assistant/services/whisper.py with WhisperTranscriber class
  - Features: async transcription with retry logic, confidence scoring from avg_logprob
  - Low-confidence detection (<80%) sets is_low_confidence flag and needs_review property
  - Supports: mp3, mp4, m4a, wav, ogg, oga, webm audio formats
  - Added tests/test_whisper.py (32 tests)
  - Commands: PYTHONPATH=src python -m pytest tests/test_whisper.py -v (32 passed)
  - Commit: pending
- Iteration 22 (T-063) - Voice Message Handler
  - Created src/assistant/telegram/handlers.py with all message handlers
  - Voice handler: downloads audio from Telegram, transcribes via Whisper, processes through MessageProcessor
  - Low-confidence transcriptions show "I heard: ..." prefix with confidence % and audio reference note
  - Command handlers: /start, /help, /today, /status, /debrief
  - Text handler: processes through MessageProcessor pipeline
  - Error handling: graceful recovery from transcription/network/processing errors
  - Added tests/test_handlers.py (19 tests)
  - Commands: PYTHONPATH=src python -m pytest tests/test_handlers.py -v (19 passed)
  - Commit: pending
- Iteration 23 (T-070) - People Lookup/Create Service
  - Service already existed in src/assistant/services/people.py with PeopleService class
  - Added comprehensive tests in tests/test_people.py (30 tests)
  - Features: lookup by name/alias, lookup_or_create, create person
  - Disambiguation logic: partner/family relationships prioritized, recency ranking, confidence scoring
  - Acceptance tests covered: AT-104 (person linking), AT-105 (person creation), AT-117 (disambiguation)
  - Commands: PYTHONPATH=src python -m pytest tests/test_people.py -v (30 passed)
  - Full test suite: 193 tests pass
  - Commit: pending
- Iteration 24 (T-071) - Places Lookup/Create Service
  - Created src/assistant/services/places.py with PlacesService class
  - Features: lookup by name/type, lookup_or_create, create, lookup_by_type, lookup_multiple
  - PlaceMatch dataclass with confidence scoring, recency sorting, rating comparison
  - PlaceType enum: restaurant, cinema, office, home, venue, other
  - Disambiguation logic: home/office types prioritized (similar to partner/family for people)
  - Confidence scoring: exact name (1.0), name starts with (0.9), name contains (0.7), address match (0.6)
  - Added NotionClient.query_places() and create_place() methods
  - Added tests/test_places.py (34 tests)
  - Commands: PYTHONPATH=src python -m pytest tests/test_places.py -v (34 passed)
  - Full test suite: 227 tests pass
  - Commit: pending
- Iteration 25 (T-072) - Projects Lookup/Create Service
  - Created src/assistant/services/projects.py with ProjectsService class
  - Features: lookup by name/status, lookup_or_create, create (with deadline support), lookup_by_status, lookup_active, lookup_multiple
  - ProjectMatch dataclass with confidence scoring, active status priority, deadline sorting
  - ProjectStatus enum: active, paused, completed, cancelled
  - ProjectType enum: work, personal
  - Disambiguation logic: active projects with confidence >= 0.7 prioritized (similar to home/office for places)
  - Confidence scoring: exact name (1.0), name starts with (0.9), name contains (0.7), word boundary match (0.65)
  - Added NotionClient.query_projects() and create_project() methods
  - Added tests/test_projects.py (40 tests)
  - Commands: PYTHONPATH=src python -m pytest tests/test_projects.py -v (40 passed)
  - Full test suite: 267 tests pass
  - Commit: pending
- Iteration 26 (T-073) - Relation Linker Service
  - Created src/assistant/services/relations.py with RelationLinker class
  - Core components:
    - LinkedEntity: dataclass for linked entities with entity_id, entity_type, name, confidence, is_new, needs_disambiguation
    - LinkedRelations: container with people/places/project lists, convenience properties (people_ids, project_id, place_ids)
    - RelationLinker: main class that integrates PeopleService, PlacesService, ProjectsService
  - Features:
    - link(): takes ExtractedEntities from entity extractor, returns LinkedRelations with Notion page IDs
    - link_people(): link list of person names to Notion records
    - link_places(): link list of place names to Notion records
    - link_project(): link single project name to Notion record
    - create_missing parameter: controls auto-creation of unknown entities
  - LinkedRelations properties:
    - people_ids: list of person page IDs for task.people_ids relation
    - project_id: single project page ID for task.project_id relation
    - place_ids: list of place page IDs (for future use)
    - needs_review: True if any entity needs disambiguation
    - new_entities_created: count of newly created entities
    - summary: human-readable description like "with Alice for Beta at Coffee Shop"
  - Confidence combining: extraction_confidence * match_confidence for final score
  - Module convenience functions: link_entities(), link_people_by_name(), link_places_by_name(), link_project_by_name()
  - Added tests/test_relations.py (44 tests)
  - Commands: PYTHONPATH=src python -m pytest tests/test_relations.py -v (44 passed)
  - Full test suite: 311 tests pass
  - Commit: pending
- Iteration 27 (T-080) - Morning Briefing Generator
  - Enhanced src/assistant/services/briefing.py with complete morning briefing format per PRD 5.2
  - Sections implemented:
    - âœ… **DUE TODAY**: Tasks due today with priority icons (ðŸ”´ urgent, ðŸŸ  high, ðŸ’­ someday)
    - âš ï¸ **NEEDS CLARIFICATION**: Flagged inbox items with interpretations, truncated previews
    - ðŸ“Š **THIS WEEK**: Upcoming tasks grouped by relative day (Tomorrow, Friday, In X days)
  - Calendar (ðŸ“… TODAY) and email (ðŸ“§ EMAIL) sections return None pending T-102/T-120
  - Enhanced NotionClient.query_tasks() with:
    - due_after: Filter tasks due on/after datetime
    - exclude_statuses: Exclude tasks with these statuses (done, cancelled, deleted)
    - limit: Pagination support
    - Sorting by due_date ascending
  - Helper methods:
    - _extract_title(), _extract_text(), _extract_select(), _extract_date()
    - _get_priority_icon(): Maps priority to emoji
    - _format_relative_day(): "Today", "Tomorrow", weekday name, or "In X days"
    - _format_tasks_due_today(), _format_flagged_items(), _format_this_week()
  - Added tests/test_briefing.py (54 tests)
  - Commands: PYTHONPATH=src python -m pytest tests/test_briefing.py -v (54 passed)
  - Full test suite: 365 tests pass (5 pre-existing flaky timezone tests in test_entities.py/test_parser.py)
  - Commit: pending
- Iteration 28 (T-081) - Scheduled Briefing Sender
  - Created deploy/systemd/ directory with systemd unit files:
    - second-brain.service: Main Telegram bot service (Type=simple, Restart=always)
    - second-brain-briefing.service: Oneshot service for sending briefing
    - second-brain-briefing.timer: Timer scheduled for OnCalendar=*-*-* 07:00:00
  - Timer features:
    - Persistent=true: Catches up on missed runs if system was off at 7am
    - RandomizedDelaySec=300: Avoids thundering herd
    - AccuracySec=1min: Wakes within 1 minute of scheduled time
  - Created deploy/systemd/install.sh: Installation script that:
    - Creates second-brain user/group
    - Creates /var/lib/second-brain directories
    - Generates /etc/second-brain.env template
    - Copies and enables systemd units
  - Created deploy/README.md: Deployment documentation
  - Updated src/assistant/services/__init__.py: Added exports for all service classes
  - Added tests/test_scheduled_briefing.py (27 tests):
    - TestSystemdFiles: Validates unit file contents
    - TestInstallScript: Validates bash script
    - TestBriefingCLI: Tests CLI command
    - TestAT106: Acceptance test for morning briefing delivery
  - Commands: PYTHONPATH=src python -m pytest tests/test_scheduled_briefing.py -v (27 passed)
  - Full test suite: 387 tests pass (5 pre-existing flaky timezone tests)
  - Commit: pending
- Iteration 29 (T-082) - /debrief Command with FSM
  - Created src/assistant/telegram/debrief.py with FSM-based interactive /debrief command
  - DebriefStates FSM: reviewing (showing item), awaiting_clarification (waiting for user input)
  - cmd_debrief: Queries unclear items via ClarificationService, stores in FSM state, shows first item
  - handle_debrief_response: Processes user input (clarification text, 'skip', 'done')
    - Clarification text â†’ creates task via ClarificationService.create_task_from_item()
    - 'skip' â†’ dismisses item via ClarificationService.dismiss_item()
    - 'done' â†’ ends session early with summary
  - Helper functions: _advance_to_next_item, _end_debrief_session, _format_item_for_review
  - Item serialization: _item_to_dict, _dict_to_item for FSM storage
  - Updated handlers.py: setup_handlers includes debrief router first (FSM needs priority)
  - Removed cmd_debrief stub from handlers.py (now in debrief.py)
  - Updated tests/test_handlers.py: Fixed imports, updated setup_handlers test for 2 routers
  - Added tests/test_debrief.py (21 tests):
    - TestDebriefCommand: no items, starts session, multiple items
    - TestDebriefResponse: done, skip, clarification, last item, empty response, error handling
    - TestFormatItemForReview: basic formatting, voice indicator, interpretation, instructions
    - TestItemSerialization: to_dict, from_dict, roundtrip
    - TestEndDebriefSession: summary, remaining count, celebration
    - TestSetupHandlers: router inclusion
    - TestAT107: Full acceptance test for interactive debrief flow
  - Commands: PYTHONPATH=src python -m pytest tests/test_debrief.py tests/test_handlers.py -v (39 passed)
  - Full test suite: 407 tests pass (5 pre-existing flaky timezone tests)
  - Commit: pending
- Iteration 30 (T-083) - Interactive Clarification Flow
  - Enhanced src/assistant/telegram/debrief.py with T-083 features per PRD 5.3:
    - Added awaiting_due_date FSM state for multi-turn due date collection
    - Added CANCEL_PATTERNS regex list for "cancel that", "already done", etc.
    - Added _is_cancel_command() for pattern detection
    - Enhanced handle_debrief_response() to:
      - Detect cancel patterns and dismiss items
      - Parse entities via EntityExtractor (people, places, dates)
      - Ask follow-up due date question for actionable tasks
    - Added handle_due_date_response() handler for due date FSM state
    - Added _create_task_with_entities() helper for task creation
    - Added helper functions: _should_ask_for_due_date, _entities_to_dict, _dict_to_entities, _format_entity_summary, _format_due_date
  - Enhanced src/assistant/services/clarification.py:
    - Added people_names and place_names parameters to create_task_from_item()
    - Added _link_people_names() helper using PeopleService.lookup_or_create()
    - Entity linking during clarification per T-083 requirements
  - Added 26 new tests in tests/test_debrief.py:
    - TestT083CancelPatterns (9 tests): cancel command detection
    - TestT083DueDateFollowUp (4 tests): multi-turn due date collection
    - TestT083EntityHandling (5 tests): entity extraction and serialization
    - TestT083DueDateFormatting (4 tests): date formatting
  - Updated existing tests to use non-actionable text (avoid triggering due date flow)
  - Bug fixes during implementation:
    - Fixed Task.people_ids validation: pass empty list not None
    - Fixed _is_cancel_command: "done" alone should end session, not cancel
  - Commands: PYTHONPATH=src python -m pytest tests/test_debrief.py -v (47 passed)
  - Full test suite: 433 tests pass (428 pass, 5 pre-existing timezone failures)
  - Commit: pending
- Iteration 31 (T-090) - Correction Handler
  - Created src/assistant/services/corrections.py with CorrectionHandler class
  - Core components:
    - RecentAction: dataclass tracking AI actions with 30-min expiry for correction context
    - CorrectionResult: dataclass for correction processing results
    - CorrectionHandler: main class with per-chat action tracking, pattern detection, value extraction
  - Detection patterns (compiled regex):
    - Direct corrections: "wrong", "that's wrong", "that's not right", "no,", "incorrect", "actually"
    - Specific corrections: "I said X not Y", "I meant X", "should be X", "it's X not Y", "change X to Y"
    - Undo requests: "undo", "cancel that", "delete that", "forget it", "nevermind"
  - Extraction patterns:
    - Parses "I said Tess not Jess" â†’ correct=Tess, wrong=Jess
    - Handles quotes, various phrasings
    - Returns (correct_value, wrong_value) tuple for update
  - Handler features:
    - track_action(): stores recent actions per chat (max 10, 30 min expiry)
    - get_last_action(): retrieves most recent non-expired action
    - is_correction(): detects correction patterns in text
    - extract_correction(): extracts corrected value from message
    - process_correction(): full flow - detect, extract, update, log
  - Entity updates via Notion API:
    - _update_task_title(), _update_person_name(), _update_place_name(), _update_project_name()
    - Sets last_modified_at timestamp
  - Correction logging:
    - _log_correction(): creates LogEntry with correction field populated
    - Enables pattern detection (T-091) by storing original â†’ corrected mappings
  - Updated src/assistant/telegram/handlers.py:
    - Imports correction handler functions
    - handle_text() checks is_correction_message() first, processes via handler
    - Tracks created tasks via track_created_task() for correction context
    - Added _extract_task_title() helper to parse titles from responses
  - Updated src/assistant/services/__init__.py:
    - Exports CorrectionHandler, CorrectionResult, convenience functions
  - Added tests/test_corrections.py (66 tests):
    - TestRecentAction: creation, expiry
    - TestCorrectionPatternDetection: 24 parametrized tests for detection patterns
    - TestCorrectionExtraction: 14 parametrized tests for value extraction
    - TestCorrectionHandlerTrackAction: tracking, multiple actions, per-chat isolation
    - TestCorrectionHandlerProcessCorrection: full processing scenarios
    - TestCorrectionHandlerEntityTypes: person/place/project corrections
    - TestAT108AcceptanceTest: full AT-108 acceptance criteria
    - TestModuleLevelFunctions: convenience function tests
    - TestHandlersIntegration: handlers.py integration tests
  - AT-108 Verification:
    - Given: AI created task "Call Jess" (tracked via track_action)
    - When: User replies "Wrong, I said Tess" (detected, extracted)
    - Then: Task updated via Notion PATCH (title â†’ "Tess")
    - And: Correction logged with correction field populated
  - Commands: PYTHONPATH=src python3 -m pytest tests/test_corrections.py -v (66 passed)
  - Full test suite: 499 tests (494 pass, 5 pre-existing timezone failures)
  - Commit: 2eb6bfd
- Iteration 32 (T-091) - Pattern Detection Service
  - Created src/assistant/services/patterns.py with PatternDetector class
  - Core components:
    - CorrectionRecord: dataclass for tracking corrections with original/corrected values, context, entity_type, timestamp
    - DetectedPattern: dataclass with trigger/meaning, occurrences, confidence, examples; properties is_ready_for_storage (>=3 occurrences), is_auto_applicable (confidence>=70)
    - PatternDetector: main class with in-memory correction history, string normalization, similarity matching
  - Detection logic:
    - add_correction(): adds record, checks for patterns via _detect_patterns_for()
    - _is_similar_correction(): matches by exact normalized values or string similarity >0.8
    - _string_similarity(): character-based similarity score 0.0-1.0
    - _create_pattern_from_corrections(): creates DetectedPattern from list of similar corrections
    - _infer_pattern_type(): infers "person"/"name"/"priority"/"date" from entity_type and context
  - Pattern storage preparation:
    - store_pattern(): creates Pattern in Notion Patterns database
    - store_pending_patterns(): stores all patterns meeting threshold
    - load_corrections_from_log(): loads correction history from Notion Log (parses "X â†’ Y" format)
    - analyze_correction_patterns(): bulk analysis of loaded history
  - Confidence calculation:
    - Initial: 50 (INITIAL_PATTERN_CONFIDENCE)
    - +10 per confirmation beyond threshold (CONFIDENCE_BOOST_PER_CONFIRMATION)
    - Extra +10 for consistent corrections (all to same value)
  - Integration with CorrectionHandler:
    - Corrections now auto-feed into pattern detection via add_correction()
    - When pattern detected (3+ occurrences), returns special message to user
  - Added NotionClient methods:
    - query_log_corrections(): fetches log entries with correction field set
    - create_pattern(): creates pattern in Patterns database
    - query_patterns(): queries patterns by trigger and min_confidence
    - update_pattern_confidence(): updates times_confirmed/times_wrong/confidence
  - Updated services/__init__.py with pattern exports
  - Added tests/test_patterns.py (33 tests):
    - TestCorrectionRecord, TestDetectedPattern, TestPatternDetectorNormalization
    - TestPatternDetectorSimilarity, TestPatternDetectorAddCorrection
    - TestPatternDetectorPendingPatterns, TestPatternDetectorStorePattern
    - TestPatternDetectorLoadCorrections, TestPatternDetectorAnalyze
    - TestPatternDetectorClearHistory, TestModuleLevelFunctions
    - TestPatternIntegrationWithCorrections, TestPRDPatternExample, TestConstants
  - Commands: PYTHONPATH=src python3 -m pytest tests/test_patterns.py -v (33 passed)
  - Full test suite: 532 tests (527 pass, 5 pre-existing timezone failures)
  - Commit: d76eba8
- Iteration 33 (T-092) - Pattern Storage
  - Implemented automatic pattern storage to Notion Patterns database
  - Enhanced src/assistant/services/patterns.py:
    - Added add_correction_and_store() async method - main entry point for auto-storage
    - Added _find_existing_pattern() - checks for duplicate patterns via query_patterns()
    - Added _update_existing_pattern() - updates existing pattern confidence instead of creating duplicate
    - Added module-level add_correction_and_store() convenience function
  - Updated src/assistant/services/corrections.py:
    - Changed from sync add_correction() to async add_correction_and_store()
    - Added enhanced response message "I've learned this pattern!" when pattern is stored
  - Updated src/assistant/services/__init__.py:
    - Added add_correction_and_store to exports
  - Added tests in tests/test_patterns.py:
    - TestT092PatternStorage (8 tests): auto_stores_pattern_when_threshold_met, no_storage_below_threshold, updates_existing_pattern, no_duplicate_patterns, storage_error_doesnt_block, multiple_patterns_stored_separately, storage_only_for_auto_applicable, async_integration
    - TestAT109PatternLearning (4 tests): priority_pattern_stored_after_three_corrections, pattern_applied_to_future_tasks, pattern_confidence_calculation, pattern_types_inferred_correctly
  - AT-109 Verification:
    - Given: User corrects priority 3 times for similar tasks (all "is_urgent" â†’ True)
    - When: Pattern confidence > 70% (reaches 70 after 3 corrections)
    - Then: Pattern stored in Notion Patterns database via create_pattern()
    - And: Future similar tasks would use learned pattern (via query_patterns lookup)
  - Commands: PYTHONPATH=src python3 -m pytest tests/test_patterns.py -v (45 passed)
  - Full test suite: 539 tests (534 pass, 5 pre-existing timezone failures)
  - Commit: 555b7b5
- Iteration 34 (T-093) - Apply Patterns to New Inputs
  - Implemented pattern application to correct learned errors before classification
  - Created src/assistant/services/pattern_applicator.py:
    - AppliedPattern dataclass: tracks applied corrections (pattern_id, trigger, meaning, original/corrected values)
    - PatternApplicationResult dataclass: tracks original vs corrected people/places/title with has_corrections property
    - PatternApplicator class with methods:
      - load_patterns(): queries Notion for patterns with confidence >= 70% (PATTERN_CONFIDENCE_THRESHOLD)
      - apply_patterns(): matches triggers against people names, place names, and title text
      - _extract_pattern_data(): parses Notion query results into pattern dictionaries
      - _matches_trigger(): fuzzy matching with normalization (exact, contains, short name in longer)
      - update_pattern_usage(): updates last_used timestamp in Notion
      - clear_cache(): forces pattern reload
    - Module-level convenience functions: get_pattern_applicator(), apply_patterns(), load_patterns()
  - Updated src/assistant/services/processor.py:
    - Added PatternApplicator to MessageProcessor.__init__()
    - Added _apply_patterns() method called before confidence routing
    - Modified ParsedIntent in-place with corrected people/places/title
    - Updated _handle_low_confidence() and _handle_high_confidence() to accept pattern_result
    - Enhanced _generate_response() to show pattern corrections to user (e.g., "I corrected 'Jess' â†’ 'Tess' based on learned patterns")
    - Added patterns_applied to ProcessResult for tracking
    - Log entries include pattern application summary
    - update_pattern_usage() called after successful task creation
  - Updated src/assistant/services/__init__.py:
    - Exported AppliedPattern, PatternApplicator, PatternApplicationResult, apply_patterns, get_pattern_applicator, load_patterns
  - Added tests/test_pattern_applicator.py (37 tests):
    - TestAppliedPattern: basic creation
    - TestPatternApplicationResult: creation, has_corrections, properties, summary
    - TestPatternApplicatorNormalization: basic, preserves content
    - TestPatternApplicatorMatching: exact, contains, short name, too short, no match
    - TestPatternApplicatorLoadPatterns: success, empty, error handling, filters invalid
    - TestPatternApplicatorApplyPatterns: no cache, corrects person, corrects place, no match, multiple people, title only
    - TestPatternApplicatorClearCache: clears cache
    - TestPatternApplicatorUpdateUsage: updates, error handling
    - TestModuleLevelFunctions: singleton, convenience functions
    - TestT093Integration: full correction flow, priority pattern, multiple patterns, respects threshold
    - TestProcessorIntegration: processor has pattern_applicator
    - TestAT109Integration: pattern applied to future task (completes AT-109 "future similar tasks use learned pattern")
  - Commands: PYTHONPATH=src python3 -m pytest tests/test_pattern_applicator.py tests/test_patterns.py -v (82 passed)
  - Full test suite: 581 tests (576 pass, 5 pre-existing timezone failures)
  - Commit: 038dfe6
- Iteration 35 (T-100) - Google Calendar OAuth
  - Task: Implement Google Calendar OAuth per PRD Section 4.4
  - Discovery: src/assistant/google/auth.py already implements complete OAuth flow:
    - GoogleAuth class with singleton instance (google_auth)
    - load_saved_credentials(): loads from ~/.second-brain/google_token.json
    - authenticate_interactive(): browser-based OAuth flow
    - get_auth_url() + complete_auth_with_code(): URL+code flow for headless/Telegram
    - Token persistence with auto-refresh on expiry
    - All 5 OAuth scopes: Calendar, Gmail (readonly/send/compose), Drive file
  - Created tests/test_google_auth.py (66 tests):
    - TestOAuthScopes: all 5 scopes present and correct
    - TestTokenPaths: path configuration
    - TestGoogleAuthInit: instance creation
    - TestGoogleAuthCredentials: validation and auto-refresh
    - TestGoogleAuthIsAuthenticated: auth state
    - TestGoogleAuthLoadSavedCredentials: token loading
    - TestGoogleAuthInteractiveAuth: browser flow
    - TestGoogleAuthSaveToken: token persistence
    - TestGoogleAuthGetAuthUrl: URL generation
    - TestGoogleAuthCompleteAuthWithCode: code exchange
    - TestGoogleAuthGetRedirectUri: redirect URI extraction
    - TestExtractOAuthCode: code extraction from URLs
    - TestGoogleAuthIntegration: full flow tests
    - TestPRDSection44Requirements: PRD compliance
    - TestOAuthFailureHandling: error handling
    - TestAT100GoogleCalendarOAuth: acceptance test
  - Commands: PYTHONPATH=src python3 -m pytest tests/test_google_auth.py -v (66 passed)
  - Full test suite: 647 tests (642 pass, 5 pre-existing timezone failures)
  - Commit: 4ebcf0c
- Iteration 36 (T-101) - Calendar Event Creator
  - Task: Create Google Calendar events from tasks with undo support per AT-110/AT-116
  - Created src/assistant/google/calendar.py with CalendarClient class:
    - CalendarEvent dataclass: event_id, title, start/end_time, timezone, attendees, location, description, html_link
    - EventCreationResult dataclass: success, event_id, html_link, undo_available_until (5 min window per PRD 6.2)
    - EventDeletionResult dataclass: success, event_id, error
    - CalendarClient methods:
      - create_event(): title, start_time, duration_minutes, timezone, attendees, location, description
      - delete_event(): for undo support within 5-minute window
      - get_event(): retrieve event by ID
      - event_exists(): check if event exists (used after delete to verify)
    - Async wrapper around synchronous Google API using run_in_executor
    - Error handling: returns error result instead of raising, 404 on delete treated as success (idempotent)
  - Added NotionClient.update_task_calendar_event(page_id, calendar_event_id) for linking tasks
  - Updated src/assistant/google/__init__.py with all calendar exports
  - Module-level convenience functions: create_calendar_event, delete_calendar_event, calendar_event_exists, get_calendar_client
  - Constants: DEFAULT_EVENT_DURATION_MINUTES=60, UNDO_WINDOW_MINUTES=5
  - Created tests/test_calendar.py (38 tests):
    - TestCalendarEvent: creation, minimal fields
    - TestEventCreationResult: successful, failed
    - TestEventDeletionResult: successful, failed
    - TestCalendarClientInit: client creation, auth detection
    - TestCalendarClientCreateEvent: not authenticated, success, attendees, location/description, custom duration
    - TestCalendarClientDeleteEvent: not authenticated, success, already deleted (idempotent)
    - TestCalendarClientGetEvent: not authenticated, success, not found
    - TestCalendarClientEventExists: true, false
    - TestModuleLevelFunctions: singleton, convenience functions
    - TestConstants: default duration, undo window
    - TestAT110GoogleCalendarCreation: event created at correct time, event_id returned for Notion link
    - TestAT116CalendarUndoWindow: event deleted within window, event confirmed deleted
    - TestNotionTaskCalendarLink: set calendar_event_id, clear calendar_event_id
    - TestTimezoneHandling: uses user timezone, explicit override
    - TestErrorHandling: API errors, unexpected exceptions
  - AT-110 Verification:
    - Given: User sends "Meeting with Mike tomorrow 2pm"
    - When: Google Calendar integration enabled
    - Then: Calendar event created via CalendarClient.create_event()
    - And: event_id returned for storing in Task.calendar_event_id via NotionClient.update_task_calendar_event()
  - AT-116 Verification:
    - Given: AI created calendar event
    - When: User says "wrong" within 5 minutes
    - Then: Calendar event deleted via CalendarClient.delete_event()
    - And: event_exists() returns False confirming deletion
  - Commands: PYTHONPATH=src python3 -m pytest tests/test_calendar.py -v (38 passed)
  - Full test suite: 680 tests (675 pass, 5 pre-existing timezone failures)
  - Commit: 31eaad8
- Iteration 37 (T-102) - Calendar Reading for Briefings
  - Task: Read upcoming calendar events for morning briefings per PRD Section 4.4
  - Enhanced src/assistant/google/calendar.py:
    - CalendarClient.list_events(): query events in time range with timezone, max_results, singleEvents=True (expands recurring)
    - CalendarClient._parse_event_response(): parses Google API response into CalendarEvent, handles both dateTime and date (all-day) formats
    - Module-level list_calendar_events(): convenience wrapper using global client
    - Module-level list_todays_events(): queries from midnight to midnight in user timezone
  - Updated src/assistant/google/__init__.py with list_calendar_events, list_todays_events exports
  - Enhanced src/assistant/services/briefing.py:
    - BriefingGenerator now accepts optional calendar_client parameter
    - _generate_calendar_section(): queries today's events via CalendarClient.list_events(), returns None if unauthenticated or no events
    - _format_calendar_events(): formats events per PRD 5.2 format ("ðŸ“… **TODAY**", "â€¢ HH:MM - Title (location)")
    - All-day events show "All day" instead of time
    - Location truncated to 30 chars with "..." if too long
    - Max 10 events shown with "+X more" indicator
  - Added T-102 tests to tests/test_calendar.py (17 new tests, 55 total):
    - TestCalendarClientListEvents: not authenticated, success, all-day events, empty response, API error, with attendees
    - TestListCalendarEventsConvenience: calls client correctly
    - TestListTodaysEventsConvenience: uses correct time range (midnight to midnight)
    - TestParseEventResponse: timed event, all-day event, missing summary, invalid returns None
    - TestT102BriefingIntegration: includes events, skips when unauthenticated, event formatting, all-day formatting
    - TestT102PRDBriefingFormat: matches PRD 5.2 example (09:00 - Standup, 14:00 - Dentist, 20:00 - Cinema (Everyman))
  - Commands: PYTHONPATH=src python3 -m pytest tests/test_calendar.py -v (55 passed)
  - Full test suite: 702 tests (697 pass, 5 pre-existing timezone failures in test_entities.py)
  - Commit: 51de73a
- Iteration 38 (T-110) - Comprehensive Audit Logging
  - Task: Implement comprehensive audit logging per PRD Section 4.9 (AT-111, AT-113)
  - Created src/assistant/services/audit.py with AuditLogger class:
    - generate_idempotency_key(): creates keys per PRD 4.9 patterns (telegram:{chat_id}:{message_id}, calendar:{task_id}:{date}, etc.)
    - check_idempotency(): queries Notion Log DB for existing entries, with in-memory cache
    - log_action(): core method creating LogEntry with timestamp, action_type, input, action_taken
    - log_deduplicated(): logs "Deduplicated" entry for AT-113 compliance
    - Convenience methods: log_capture, log_create, log_update, log_delete, log_calendar_create, log_briefing, log_error
    - mark_undone(): marks log entry as undone for rollback tracking
    - query_log(): filter entries by action_type, since, entity_id
    - Undo window tracking (5 min per PRD 6.2)
  - Module-level convenience functions:
    - get_audit_logger(): singleton accessor
    - log_action(): direct logging shortcut
    - check_and_log_idempotency(): returns (should_proceed, dedupe_entry) tuple
  - Created tests/test_audit.py with 30 tests:
    - TestIdempotencyKeyGeneration (4): telegram, calendar, email, briefing patterns
    - TestIdempotencyCheck (3): new key, existing key, cached key
    - TestLogAction (5): creates entry, includes timestamp, with undo window, with correction, without Notion
    - TestLogDeduplicated (1): creates dedupe entry with prefix
    - TestConvenienceMethods (10): log_capture, log_create_task, log_create_calendar_event, log_update, log_delete_soft/hard, log_calendar_create, log_briefing, log_error
    - TestModuleLevelFunctions (3): singleton, check new/duplicate
    - TestQueryLog (3): by action_type, since, entity_id
    - TestAT111EveryActionLogged (1): all ActionType values loggable
    - TestAT113Idempotency (1): duplicate message logged as "deduplicated"
  - AT-111 Verification: Every action type can be logged with timestamp, action_type, input, action_taken
  - AT-113 Verification: Second attempt with same idempotency_key returns DUPLICATE and logs "Deduplicated" entry
  - Type-checked with mypy (0 errors)
  - Commands: python3 -m pytest tests/test_audit.py -v (30 passed)
  - Full test suite: 727 tests (722 pass, 5 pre-existing timezone failures in test_entities.py)
  - Commit: c4fe4a1
- Iteration 39 (T-114) - Offline Queue and Recovery
  - Task: Implement offline queue and recovery per PRD Section 4.8 (AT-114, AT-115)
  - Created src/assistant/services/offline_queue.py with OfflineQueue class:
    - QueuedActionType enum: CREATE_INBOX, CREATE_TASK, UPDATE_ENTITY, DELETE_ENTITY
    - QueuedAction dataclass: action_type, idempotency_key, raw_input, payload, queued_at, retry_count
    - QueueProcessResult dataclass: successful, failed, duplicate counts
    - OfflineQueue class with JSONL persistence at ~/.second-brain/queue/pending.jsonl
    - enqueue(): appends action to queue file
    - queue_inbox_item(): convenience method for inbox items with confidence/interpretation
    - queue_task(): convenience method for task creation
    - get_pending_count(): counts queued items
    - process_queue(): processes all queued items with deduplication by idempotency_key
    - Module-level convenience functions: get_offline_queue(), queue_for_offline_sync(), process_offline_queue(), get_offline_response()
    - get_offline_response(): returns "Saved locally, will sync when Notion is back" per PRD 4.8
  - Updated src/assistant/services/__init__.py:
    - Added all offline_queue exports
  - Updated src/assistant/cli.py:
    - Enhanced sync command to use OfflineQueue service
    - Reports pending count, successful/failed/duplicate results
  - Created tests/test_offline_queue.py (26 tests):
    - TestOfflineQueue (5): creates directory, enqueues to file, loads entries, clears queue, empty queue
    - TestQueueInboxItem (3): creates action, uses idempotency key, includes metadata
    - TestQueueTask (3): creates action, uses idempotency key, includes payload
    - TestQueueProcessing (5): processes in order, handles failure, deduplicates, retries failed, respects max retries
    - TestAT114OfflineCapture (2): user receives immediate response, item queued for later
    - TestAT115RecoverySync (2): items synced in order, queue cleared after success
    - TestConvenienceFunctions (4): singleton, queue_for_offline_sync, process returns result, offline response
    - TestQueuedAction (2): to_dict, from_dict
  - AT-114 Verification: get_offline_response() returns "Saved locally, will sync when Notion is back"
  - AT-115 Verification: 3 items queued, processed in order, queue cleared, all 3 successful
  - Ruff fixes applied (16 issues: unused imports, unsorted imports)
  - Commands: python3 -m pytest tests/test_offline_queue.py -v (26 passed)
  - Full test suite: 753 tests (748 pass, 5 pre-existing timezone failures in test_entities.py)
  - Commit: 9d1adbf
- Iteration 40 (T-115) - Soft Delete and Undo
  - Task: Implement soft delete and undo per PRD Section 5.6 and 6.2 (AT-118)
  - Created src/assistant/services/soft_delete.py with SoftDeleteService class:
    - DeletedAction dataclass: entity_type, entity_id, title, deleted_at, chat_id, message_id
    - is_within_undo_window(): checks if deletion is within 30-day window
    - DeleteResult dataclass: success, entity_id, entity_type, title, message, can_undo
    - UndoResult dataclass: success, entity_id, entity_type, title, message
    - SoftDeleteService class with per-chat deletion tracking:
      - soft_delete(): calls NotionClient.soft_delete(), tracks for undo, logs action
      - undo_last_delete(): restores last deleted item within 30-day window
      - restore_by_id(): restores specific entity by ID
      - _track_deletion(): maintains per-chat deletion history (max 50 items)
      - _get_last_deleted(): returns most recent restorable item
      - get_pending_deletes_count(): counts items that can still be undone
    - Pattern matching functions:
      - is_undo_command(): matches "undo", "restore", "bring back", "undelete", "recover"
      - is_delete_command(): matches "delete that", "remove this", "forget it"
    - Module-level singleton and convenience functions
  - Updated src/assistant/services/__init__.py:
    - Added all soft_delete exports (DeletedAction, DeleteResult, SoftDeleteService, etc.)
  - Created tests/test_soft_delete.py (54 tests):
    - TestDeletedAction (4): fresh within window, old outside window, at boundary, custom days
    - TestSoftDeleteService (11): soft_delete success/failure, undo success/no_deletes/outside_window, multiple deletes LIFO order, per-chat isolation, restore_by_id, pending count, max limit
    - TestPatternMatching (28): is_undo_command (14 cases), is_delete_command (14 cases)
    - TestConvenienceFunctions (2): soft_delete function, undo function
    - TestAT118Integration (2): full deleteâ†’undo flow, undo after 30 days fails
  - AT-118 Verification:
    - Given: Task "Buy groceries" exists
    - When: User says "delete that"
    - Then: Task.deleted_at set to current timestamp (soft_delete called)
    - When: User says "undo" within 30 days
    - Then: Task.deleted_at cleared, task visible again (undo_delete called)
    - Undo after 30 days returns "Can't undo" message
  - Commands: python3 -m pytest tests/test_soft_delete.py -v (54 passed)
  - Full test suite: 807 tests (802 pass, 5 pre-existing timezone failures in test_entities.py)
  - Commit: 9344e29
- Iteration 41 (T-116) - Timezone Handling
  - Task: Implement timezone handling per PRD Section 5.4 and AT-119
  - Created src/assistant/services/timezone.py with TimezoneService class:
    - TIMEZONE_ABBREVIATIONS: dict mapping EST/PST/CST/MST/UTC/GMT etc. to IANA names
    - ParsedTimezone dataclass: timezone_name, original_text, confidence
    - TimezoneAwareDateTime dataclass: datetime_value, timezone_name
      - is_utc property, to_iso8601(), to_iso8601_utc(), to_utc(), to_timezone()
    - TimezoneService class:
      - default_timezone from settings or explicit parameter
      - now(), today(): current time in user timezone
      - parse_explicit_timezone(): extracts "9am EST" patterns
      - create_datetime(): creates timezone-aware datetime
      - localize(): attaches timezone to naive or converts aware datetime
      - parse_time_with_timezone(): parses time respecting explicit markers
      - format_for_display(): "2pm" or "2:30pm" format
    - Module-level singleton and convenience functions
  - Updated src/assistant/services/entities.py:
    - Replaced pytz with zoneinfo (modern Python 3.9+ stdlib)
    - Added has_explicit_timezone field to ExtractedDate
    - Added to_iso8601() and to_iso8601_utc() methods to ExtractedDate
    - Added EXPLICIT_TZ_PATTERN regex and _extract_time_with_explicit_tz()
    - Modified extract_dates() to detect explicit timezone markers
  - Updated src/assistant/services/__init__.py:
    - Added timezone service exports
  - Created tests/test_timezone.py (41 tests):
    - TestTimezoneAbbreviations: US/EU/UTC mapping, IANA validation
    - TestTimezoneAwareDateTime: creation, is_utc, ISO formatting, conversion
    - TestTimezoneService: all methods
    - TestModuleLevelFunctions: singleton, convenience functions
    - TestAT119Acceptance: full acceptance test, explicit timezone override, relative time
    - TestPRDSection54Examples: all PRD examples covered
  - Updated tests/test_entities.py:
    - Fixed all timezone-aware comparisons using datetime.now(self.tz)
    - Added TestTimezoneHandling, TestExtractedDate, TestTimezoneAbbreviations classes
    - All 27 existing tests now use timezone-aware comparisons
  - Fixed tests/test_parser.py:
    - test_parse_task_with_tomorrow now uses timezone-aware comparison
  - AT-119 Verification:
    - Given: User timezone is "America/Los_Angeles" (PST/PDT)
    - When: User sends "tomorrow 2pm"
    - Then: due_date stored as 2pm in PST/PDT
    - And: due_timezone field set to "America/Los_Angeles"
    - When: User sends "9am EST"
    - Then: due_timezone set to "America/New_York", has_explicit_timezone=True
  - Ruff fixes: 22 issues (unused imports, unsorted imports, deprecated Optional)
  - Commands: python3 -m pytest tests/test_timezone.py tests/test_entities.py -v (all passed)
  - Full test suite: 873 tests (all pass, fixed 5 pre-existing timezone failures)
  - Commit: 5dba2b0
- Iteration 42 (T-120) - Gmail Read Integration
  - Task: Implement Gmail read integration per PRD Section 4.5 for morning briefings
  - Created src/assistant/google/gmail.py with GmailClient class:
    - EmailMessage dataclass: message_id, thread_id, subject, sender_name/email, snippet, 
      received_at, is_read, labels, needs_response, priority (high/normal/low), has_attachments
    - EmailListResult dataclass: success, emails list, error, total_count
    - GmailClient class:
      - service property: lazy Gmail API client initialization with OAuth
      - is_authenticated(): checks for valid credentials
      - list_emails(): query Gmail with label/query filters, promotional filtering via SKIP_LABELS
      - list_unread(): filter by is:unread and since_hours
      - list_needing_response(): uses ACTION_PATTERNS regex to detect emails requiring response
        (questions, "please send", "waiting for your response", "action required", etc.)
      - get_email(): single email by ID
      - _parse_message(): converts Gmail API response to EmailMessage
      - _parse_date(): email date header parsing with fallback
      - _has_attachments(): recursive payload inspection
      - _needs_response(): regex pattern matching
      - _determine_priority(): IMPORTANT label, urgent keywords detection
    - Module-level singleton and convenience functions
  - Updated src/assistant/google/__init__.py:
    - Added Gmail exports: GmailClient, EmailMessage, EmailListResult, get_gmail_client,
      list_emails, list_unread_emails, list_emails_needing_response, get_email_by_id
  - Updated src/assistant/services/briefing.py:
    - Added gmail_client parameter to BriefingGenerator.__init__()
    - Implemented _generate_email_section(): queries list_needing_response(max_results=5, since_hours=48)
    - Added _format_email_section(): formats per PRD 5.2 ("ðŸ“§ EMAIL (N need attention)")
    - Added _format_time_ago(): relative timestamp formatting ("2 hours ago", "1 day ago")
  - Created tests/test_gmail.py (33 tests):
    - TestEmailMessage: creation, defaults
    - TestEmailListResult: success/error results
    - TestGmailClient: auth, needs_response patterns, priority, date parsing, attachments, message parsing
    - TestGmailClientAsync: list_emails, filters, unread, needing_response, get_email
    - TestGmailModuleFunctions: singleton, convenience functions
    - TestBriefingEmailIntegration: email section no gmail, no emails, with emails, time formatting
  - Commands: python3 -m pytest tests/test_gmail.py -v (33 passed)
  - Full test suite: 906 tests (all pass)
  - Commit: 2965eca

- Iteration 28 (T-121): Gmail draft creation
  - Task: Add Gmail draft creation and sending capabilities per PRD Section 4.5/6.3
  - PRD Compliance:
    - Section 4.5: "Draft only (default) - Creates draft, notifies you"
    - Section 6.3: "Send email - Yes - show draft first"
    - Section 6.2: "Email sent - Cannot undo - Log only"
  - Updated src/assistant/google/gmail.py:
    - Added DraftResult dataclass: draft_id, message_id, thread_id, subject, to/cc/bcc, body, html_link, preview property
    - Added SendResult dataclass: success, message_id, thread_id, error
    - GmailClient.create_draft(): creates MIME message with base64 encoding, supports thread_id/in_reply_to for replies
    - GmailClient.get_draft(): retrieves draft details with _extract_body() for multipart
    - GmailClient.send_draft(): sends existing draft, logs sent message
    - GmailClient.delete_draft(): removes draft when user cancels
    - GmailClient.send_email(): direct send convenience (for post-confirmation)
    - _extract_body(): extracts plain text from MIME payload (handles multipart)
  - Added convenience functions: create_draft, get_draft, send_draft, delete_draft, send_email
  - Updated tests/test_gmail.py (24 new tests, 57 total):
    - TestDraftResult: success, error, preview generation, preview error, truncation (5)
    - TestSendResult: success, error (2)
    - TestGmailClientDrafts: auth, no recipients, success, reply, get, send, delete (10)
    - TestDraftConvenienceFunctions: all 5 functions
    - TestDraftWorkflow: complete send flow, cancel flow (2)
  - Commands: python3 -m pytest tests/test_gmail.py -v (57 passed)
  - Full test suite: 930 tests (all pass)
  - Commit: 55a83c5

- Iteration 29 (T-130): Proactive nudges
  - Task: Implement "Don't forget X" proactive reminders per PRD 2.2 ("Tap on Shoulder")
  - PRD Context: "Push relevant info at right time" - Morning briefing handles daily overview, nudges handle timely reminders throughout the day
  - Created src/assistant/services/nudges.py with NudgeService class:
    - NudgeType enum: DUE_TODAY (2pm-8pm), DUE_TOMORROW (6pm-9pm), OVERDUE (9am-8pm), HIGH_PRIORITY (broad window)
    - NudgeCandidate dataclass: task_id, title, due_date, priority, nudge_type, days_overdue
    - NudgeReport/NudgeResult: tracking for send success/failure/skipped
    - Time-windowed nudging: 2pm for due today, 6pm for due tomorrow, 9am for overdue
    - Deduplication via ~/.second-brain/nudges/sent.json (7-day automatic cleanup)
    - format_nudge_message(): creates "Don't forget X is due today", "Heads up: X is due tomorrow", "Overdue: X was due yesterday"
    - High priority tasks get upgraded to HIGH_PRIORITY type with broader windows
    - get_nudge_candidates(): queries Notion for tasks due today/tomorrow/overdue
    - filter_candidates(): applies time windows and deduplication
    - send_nudges(): sends via Telegram, marks as sent
    - run(): complete cycle with Notion client cleanup
  - Updated src/assistant/cli.py:
    - Added send_nudges() async function
    - Added "nudge" subcommand: "Send proactive task reminders"
  - Updated src/assistant/services/__init__.py:
    - Exported: NudgeCandidate, NudgeReport, NudgeResult, NudgeService, NudgeType, format_nudge_message, get_nudge_service, get_pending_nudges, run_nudges
  - Created deploy/systemd/second-brain-nudge.service:
    - Oneshot service running "python -m assistant nudge"
    - Security hardening: NoNewPrivileges, ProtectSystem, PrivateTmp
  - Created deploy/systemd/second-brain-nudge.timer:
    - OnCalendar=*-*-* 09:00:00 (overdue check)
    - OnCalendar=*-*-* 14:00:00 (due today reminders)
    - OnCalendar=*-*-* 18:00:00 (due tomorrow heads-up)
    - Persistent=true for missed runs
  - Created tests/test_nudges.py (49 tests):
    - TestNudgeCandidate, TestNudgeReport, TestNudgeResult: dataclass tests
    - TestNudgeWindows: time window validation (10 tests)
    - TestNudgeTracking: deduplication save/load/has_been_nudged (6 tests)
    - TestFormatNudgeMessage: message formatting (6 tests)
    - TestNudgeService: candidates, filtering, sending, run cycle (8 tests)
    - TestModuleLevelFunctions: convenience functions (2 tests)
    - TestSystemdFiles: service/timer validation (6 tests)
    - TestCLIIntegration: CLI command test (1 test)
    - TestT130PRDRequirements: PRD compliance (4 tests)
  - Commands: python3 -m pytest tests/test_nudges.py -v (49 passed)
  - Full test suite: 979 tests (all pass)
  - Commit: 701d87a

- Iteration 30 (T-200): Create Dockerfile (multi-stage)
  - Task: Create multi-stage Dockerfile for production deployment per PRD 1.2 and AT-201
  - Created Dockerfile with two-stage build:
    - Stage 1 (builder): python:3.12-slim, installs deps in venv, builds wheel
    - Stage 2 (runtime): python:3.12-slim, copies venv from builder, minimal image
  - Security features:
    - Non-root user (secondbrain:secondbrain, UID/GID 1000)
    - Creates /var/lib/second-brain directories per PRD 1.2
    - PYTHONDONTWRITEBYTECODE=1, PYTHONUNBUFFERED=1
    - pip --no-cache-dir, apt rm -rf /var/lib/apt/lists
  - Production features:
    - HEALTHCHECK using "python -m assistant check"
    - Default CMD runs Telegram bot
    - OCI labels for container metadata
    - TZ environment variable for timezone
  - Created .dockerignore:
    - Excludes .git, .venv, tests/, .env, credentials, logs, scripts
    - Keeps build context minimal
  - Created tests/test_dockerfile.py (36 tests):
    - TestDockerfileStructure (15): Python 3.12, slim, multi-stage, user, healthcheck, venv
    - TestDockerfileSecurityPractices (5): no secrets, cleanup, app directories
    - TestDockerignore (7): excludes git, venv, tests, env, credentials
    - TestAT201MultiStageDockerfile (5): multiple FROM, builder deps, runtime copies venv
    - TestDockerBuildValidation (4): syntax, FROM format, COPY format, no ADD
  - Commands: python3 -m pytest tests/test_dockerfile.py -v (36 passed)
  - Full test suite: 1015 tests (all pass)
  - Commit: 40bc35f

- Iteration 31 (T-201): Create docker-compose.yml
  - Task: Create Docker Compose configuration for production deployment per AT-202
  - PRD Compliance:
    - PRD 1.2: container_name 'second-brain' for docker exec from systemd timer
    - PRD 1.2: restart: unless-stopped for auto-recovery
    - PRD 1.3: env_file /etc/second-brain.env for secrets
    - PRD 4.8: Volume mount for offline queue
  - Created docker-compose.yml with:
    - Service: second-brain with local Dockerfile build
    - container_name: second-brain (for docker exec second-brain python -m assistant briefing)
    - restart: unless-stopped (survives reboots, respects manual stops)
    - env_file: /etc/second-brain.env
    - environment: TZ=${TZ:-America/Los_Angeles}, SECOND_BRAIN_HOME, PYTHON* settings
    - Volumes: tokens, cache, logs, queue, nudges (all in /var/lib/second-brain/)
    - healthcheck: python -m assistant check with 30s interval, 10s timeout, 3 retries
    - deploy.resources.limits: cpus 1.0, memory 512M
    - deploy.resources.reservations: cpus 0.25, memory 128M
    - logging: json-file with max-size 10m, max-file 3
    - security_opt: no-new-privileges:true
    - read_only: true with tmpfs for /tmp
  - Updated pyproject.toml:
    - Added pyyaml>=6.0.0 to dev dependencies for YAML parsing in tests
  - Created tests/test_docker_compose.py (41 tests):
    - TestDockerComposeStructure (5): file exists, valid YAML, services section
    - TestDockerComposeService (5): Dockerfile, image tag, restart, env_file, timezone
    - TestDockerComposeVolumes (5): tokens, cache, logs, queue, absolute paths
    - TestDockerComposeHealthCheck (5): configured, assistant check, interval, timeout, retries
    - TestDockerComposeResourceLimits (3): limits configured, memory, CPU
    - TestDockerComposeLogging (3): driver, max-size, max-file
    - TestDockerComposeSecurity (3): security_opt, no-new-privileges, read-only
    - TestAT202DockerCompose (7): AT-202 acceptance tests
    - TestDockerComposeDocumentation (1): has comments
    - TestDockerComposePRDCompliance (4): PRD 1.2/1.3/4.8 compliance
  - Commands: python3 -m pytest tests/test_docker_compose.py -v (41 passed)
  - Full test suite: 1056 tests (all pass)
  - Commit: ae2e29c

- Iteration 32 (T-202): GitHub Actions CI Pipeline
  - Task: Set up GitHub Actions CI for lint, type-check, and test on every PR per PRD 12.5
  - PRD Compliance:
    - PRD 12.5: "GitHub Actions - CI (ci.yml)" with lint, type-check, test jobs
    - AT-203: "Given: PR opened against main, When: GitHub Actions CI runs, Then: All jobs pass"
  - Created .github/workflows/ci.yml:
    - name: CI
    - Triggers: push to main, pull_request to main
    - Concurrency: cancel-in-progress for same branch
    - Jobs: lint, type-check, test, ci-success
    - lint: ruff check src tests, ruff format --check src tests
    - type-check: mypy src
    - test: pytest --cov=assistant --cov-report=xml, codecov upload
    - ci-success: summary job depending on all others
    - All jobs use ubuntu-latest, Python 3.12, pip cache
    - Security: env vars for interpolation, pinned action versions
  - Created tests/test_ci_workflow.py (38 tests):
    - TestCIWorkflowExists (3): file exists, valid YAML, has name
    - TestCIWorkflowTriggers (2): push, pull_request triggers
    - TestCIWorkflowJobs (4): lint, type-check, test jobs, ubuntu-latest
    - TestLintJob (5): checkout, python, deps, ruff check, ruff format
    - TestTypeCheckJob (3): checkout, python, mypy
    - TestTestJob (5): checkout, python, pytest, coverage, codecov
    - TestCIConcurrency (2): config, cancel-in-progress
    - TestCISuccessJob (3): exists, depends on all, runs always
    - TestAT203CIPipelinePasses (5): acceptance test validation
    - TestPRDSection125Compliance (3): checkout v4, setup-python v5, dev deps
    - TestGitHubActionsSecurityBestPractices (3): no direct interpolation, pinned versions, secrets
  - Fixed pre-existing lint issues with ruff --fix
  - YAML quirk: 'on' key parsed as boolean True
  - Commands: python3 -m pytest tests/test_ci_workflow.py -v (38 passed)
  - Full test suite: 1094 tests (all pass)
  - Commit: f8e0d29
